<?xml version="1.0" encoding="utf-8" ?>
<nlog xmlns="http://www.nlog-project.org/schemas/NLog.xsd"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      autoReload="true"
      throwConfigExceptions="true"
      internalLogLevel="Info"
      internalLogFile="Logs\nlog-internal.log">

  <!-- ✨ 优化点1: 定义全局变量简化配置 -->
  <variable name="logDirectory" value="Logs"/>
  <variable name="defaultLayout" 
            value="[${longdate}] [${uppercase:${level}}] [${logger}]${newline}${message}${newline}${onexception:${exception:format=tostring}${newline}}===========================================${newline}"/>

  <targets async="true">
    
    <!-- ✨ 优化点2: 使用统一的文件目标配置，添加归档策略 -->
    
    <!-- Trace级别日志 -->
    <target xsi:type="File" 
            name="TraceFile" 
            fileName="${logDirectory}\Trace\${shortdate}.log"
            layout="${defaultLayout}"
            archiveFileName="${logDirectory}\Trace\Archive\{#}.log"
            archiveEvery="Day"
            archiveNumbering="Date"
            archiveDateFormat="yyyy-MM-dd"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- Debug级别日志 -->
    <target xsi:type="File" 
            name="DebugFile" 
            fileName="${logDirectory}\Debug\${shortdate}.log"
            layout="${defaultLayout}"
            archiveFileName="${logDirectory}\Debug\Archive\{#}.log"
            archiveEvery="Day"
            archiveNumbering="Date"
            archiveDateFormat="yyyy-MM-dd"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- Info级别日志 -->
    <target xsi:type="File" 
            name="InfoFile" 
            fileName="${logDirectory}\Info\${shortdate}.log"
            layout="${defaultLayout}"
            archiveFileName="${logDirectory}\Info\Archive\{#}.log"
            archiveEvery="Day"
            archiveNumbering="Date"
            archiveDateFormat="yyyy-MM-dd"
            maxArchiveFiles="30"
            encoding="utf-8" />

    <!-- Warn级别日志 -->
    <target xsi:type="File" 
            name="WarnFile" 
            fileName="${logDirectory}\Warn\${shortdate}.log"
            layout="${defaultLayout}"
            archiveFileName="${logDirectory}\Warn\Archive\{#}.log"
            archiveEvery="Day"
            archiveNumbering="Date"
            archiveDateFormat="yyyy-MM-dd"
            maxArchiveFiles="60"
            encoding="utf-8" />

    <!-- Error级别日志 -->
    <target xsi:type="File" 
            name="ErrorFile" 
            fileName="${logDirectory}\Error\${shortdate}.log"
            layout="${defaultLayout}"
            archiveFileName="${logDirectory}\Error\Archive\{#}.log"
            archiveEvery="Day"
            archiveNumbering="Date"
            archiveDateFormat="yyyy-MM-dd"
            maxArchiveFiles="90"
            encoding="utf-8" />

    <!-- Fatal级别日志 -->
    <target xsi:type="File" 
            name="FatalFile" 
            fileName="${logDirectory}\Fatal\${shortdate}.log"
            layout="${defaultLayout}"
            archiveFileName="${logDirectory}\Fatal\Archive\{#}.log"
            archiveEvery="Day"
            archiveNumbering="Date"
            archiveDateFormat="yyyy-MM-dd"
            maxArchiveFiles="365"
            encoding="utf-8" />

    <!-- ✨ 优化点3: 添加统一的所有日志文件（方便快速查看） -->
    <target xsi:type="File" 
            name="AllFile" 
            fileName="${logDirectory}\All\${shortdate}.log"
            layout="${defaultLayout}"
            archiveFileName="${logDirectory}\All\Archive\{#}.log"
            archiveEvery="Day"
            archiveNumbering="Date"
            archiveDateFormat="yyyy-MM-dd"
            maxArchiveFiles="7"
            encoding="utf-8" />

    <!-- 控制台输出 -->
    <target xsi:type="ColoredConsole" 
            name="coloredConsole"
            layout="[${time}] [${level:uppercase=true}] ${message} ${exception:format=message}" />

    <!-- ✨ 优化点4: 数据库目标 - 优化字段和性能 -->
    <target name="database"
            xsi:type="Database"
            dbProvider="MySqlConnector.MySqlConnection, MySqlConnector"
            connectionString="server=localhost;port=3306;database=TestBenchData;uid=root;pwd=123456;charset=utf8mb4;"
            keepConnection="true">
      <commandText>
        INSERT INTO LoggerInfo(MessTime, Level, Message, UserName, MessageName, Source, TestBenchID)
        VALUES(@MessTime, @Level, @Message, @UserName, @MessageName, @Source, @TestBenchID)
      </commandText>
      <parameter name="@MessTime" layout="${date:format=yyyy-MM-dd HH\:mm\:ss.fff}" />
      <parameter name="@Level" layout="${level}" />
      <parameter name="@Message" layout="${message}${onexception:${newline}${exception:format=tostring}}" />
      <parameter name="@UserName" layout="${event-properties:UserName}" />
      <parameter name="@MessageName" layout="${event-properties:MessageName}" />
      <parameter name="@Source" layout="${event-properties:Source}" />
      <parameter name="@TestBenchID" layout="${event-properties:TestBenchID}" />
    </target>

    <!-- ✨ 优化点5: 添加错误日志邮件通知（可选，需要配置SMTP） -->
    <!--
    <target name="mail"
            xsi:type="Mail"
            smtpServer="smtp.example.com"
            smtpPort="587"
            smtpAuthentication="Basic"
            smtpUserName="your-email@example.com"
            smtpPassword="your-password"
            enableSsl="true"
            from="noreply@example.com"
            to="admin@example.com"
            subject="【严重】系统发生Fatal错误"
            body="${message}${newline}${exception:format=tostring}"
            />
    -->
  </targets>

  <rules>
    <!-- 跳过Microsoft组件日志 -->
    <logger name="Microsoft.*" final="true" />

    <!-- ✨ 优化点6: 所有日志写入统一文件（方便查看） -->
    <logger name="*" minlevel="Debug" writeTo="AllFile" />

    <!-- 按级别写入不同文件 -->
    <logger name="*" level="Trace" writeTo="TraceFile" />
    <logger name="*" level="Debug" writeTo="DebugFile" />
    <logger name="*" level="Info" writeTo="InfoFile" />
    <logger name="*" level="Warn" writeTo="WarnFile" />
    <logger name="*" level="Error" writeTo="ErrorFile" />
    <logger name="*" level="Fatal" writeTo="FatalFile" />

    <!-- 写数据库：Warn及以上等级 -->
    <logger name="*" minlevel="Warn" writeTo="database"/>

    <!-- ✨ 优化点7: Fatal级别发送邮件通知（需要先配置上面的mail target） -->
    <!--<logger name="*" level="Fatal" writeTo="mail"/>-->

    <!-- 控制台输出：Debug及以上 -->
    <logger name="*" minlevel="Debug" writeTo="coloredConsole" />
  </rules>
</nlog>